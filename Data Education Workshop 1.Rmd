---
title: "Data Education Workshop 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = FALSE, message = FALSE)
```

### Introduction
The Center for Systems Science and Engineering at Johns Hopkins was among the earliest to collect and publish global data related to the COVID-19 pandemic. The data used for their [reporting dashboard](https://coronavirus.jhu.edu/map.html), aggregated from multiple sources and updated daily, is freely available on [Github](https://github.com/CSSEGISandData/COVID-19). 

We will review a basic overview of the following steps in data analysis: 
1. Data Import and Cleaning
2. Exploratory Data Analysis & Visualization 
3. Regression and Classification

#### Setting Up R:
We will go over this in more detail in our next workshop which will help you get oriented and set up! 
1. Create New Project (Via Github Repository) & Establish Working Directory 
2. Create a File (RMD)
3. Load Packages Chunk

#### Load Packages:
```{r}
library(tidyverse)
library(lubridate)
library(zoo)
library(maps)
library(tidyr)
library(ggplot2)
library(ggthemes)
```

#### Data Import and Cleaning
Step 0: Finding Data (Look for CSV Files!) 
Step 1: Read in data for  (Make sure you either use raw data link if available or import your CSV file into the same working directory as your Rmd file.) 
Step 2: View Data & Decide What Needs to be "Cleaned"  
Step 3: Data Cleaning! 

```{r}
#Reading in the case data
cases <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
``` 

Reshape the data to long format, so that instead of having many columns of cases for each date, you have one column that stores the cases and one column that stores the dates. 

```{r}
cases_long <- cases %>% gather(date, cases, "1/22/20":"10/31/20") 
#Along the way you can "View" your data set, but be sure to remove the "View" code from your final RMD before you knit it into an HTML otherwise the whole table will print in the HTML. 
#View
```

Convert the new date column to be a date class instead of a character class. 

```{r}
#Check Class
class(cases_long$date)

cases_long$date <-as.Date(cases_long$date, "%m/%d/%y")

#Re-Check Class
class(cases_long$date)
class(cases_long$cases)
```

This data set keeps track of the number of confirmed cases reported for states, provinces, and other sub-regions within a given country but we just want total country data. This data frame also still includes a bunch of other information we're not interested in (Latitude Longitude Etc...) 

We can create a new data frame with only what we're interested in: country name, date, and the total number of cases in the country on that day. 

We can do this by summing up the cases across all of the states/provinces within each country and date.

```{r}
cases_long_country <- cases_long %>% rename(country ="Country/Region") %>%  group_by(country, date) %>% summarize(cases=sum(cases), .groups = "drop") 

#View
```

So now we're ready for the fun part!

#### Exploratory Data Analysis and Visualizations
Step 1: What do we want to explore? 
Step 2: Whats the best way to visualize it? 
Step 3: Repeat Steps 1 and 2 Forever

So lets say we want to look at only a few countries first to compare their COVID Cases: Armenia, Azerbaijan, Turkey, Georgia, Russia. 

Perhaps the best way to visualize this is a line plot with cases on the Y axis and date on the X axis. But first, we have to restrict our data to only those countries we're interested in including in our plot.

```{r}
countries = c("Armenia", "Azerbaijan","Turkey","Georgia","Russia")
plot1data <- cases_long_country %>% filter(country %in% countries)
ggplot(plot1data, aes(x=date, y=cases, color=country)) + geom_line() + scale_x_date(date_breaks = "1 month", date_labels = "%b") + labs(x = "Date", y = "Cases", title = "Total Confirmed Cases Over Time") + guides(color = guide_legend(title="Country"))
```

The number of cases varies greatly across these five countries. This stretches out the scale of the y-axis and making it hard to see what’s going on in countries where there are fewer cases. Transforming the data can make it easier to interpret your time series plot. We're going to redo this same plot but use a log scale transformation (with base 10) for the y-axis.

```{r}
countries = c("Armenia", "Azerbaijan","Turkey","Georgia","Russia")
plot1data <- cases_long_country %>% filter(country %in% countries)
ggplot(plot1data, aes(x=date, y=cases, color=country)) + geom_line() + scale_y_log10() + scale_x_date(date_breaks = "1 month", date_labels = "%b") + labs(x = "Date", y = "Cases (Log Scale)", title = "Total Confirmed Cases Over Time (Log Scale)") + guides(color = guide_legend(title="Country"))
```

Many public health professionals have been measuring new confirmed cases over a 7 day period (or "7 Day Rolling Averages").
Lets try to make a new variable that calculates that.We will define the seven-day rolling average of new cases as the average of the new cases reported on a given day, the three days before, and the three days after. It’s a “rolling” average because the window of seven days moves along as you calculate the averages for new dates.

```{r}
cases_long_country <- cases_long_country %>% group_by(country) %>% arrange(date) %>%
mutate(new_cases = cases - lag(cases), new_cases_7dayavg = rollmean(new_cases, k = 7, fill = NA)) %>% ungroup()

#View
```

Let's Plot It! 

```{r}
ggplot(cases_long_country %>% filter(country %in% countries), aes(x=date, y=new_cases_7dayavg, color=country)) +  geom_line() + scale_x_date(date_breaks = "1 month", date_labels = "%b") + labs(x = "Date", y = "New Cases (7-day Rolling Average)", title = "New Confirmed Cases Over Time") + guides(color = guide_legend(title="Country"))
```

Since these countries all have different population sizes, it might be more informative to look at the new cases per-capita. For this we need to use a different data set available again from the Johns Hopkins [Github] (https://github.com/CSSEGISandData/COVID-19) page. 

```{r}
#Reading in the population data
population_data <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv")

#View
``` 

Back to data cleaning for a minute here: Ultimately we just want the population information in our original case data set that we've been working with this entire time. So let's try to join both data frames together, but before we do that, lets get rid of everything we don't need from this new population data set. 

First, we create a new data frame that stores only the country-level populations, aka where Province_State is NA. Then we get rid of the columns we don't want and rename everything to look nice and match to our existing data_set. 

```{r}
population_data <- population_data %>% subset(is.na(Province_State)) %>% rename(country="Country_Region", population ="Population") %>% select(country, population)

#View
```

Time to join the two data frames (yay!)

```{r}
finaldata <- left_join(cases_long_country, population_data, by = "country")
#View
```

Now its time to account for population in our data analysis. Let's do this by creating a new variable that calculates the seven-day rolling average of new cases per million.

```{r}
finaldata <- finaldata %>% mutate(rollingavg_per_million = 1e6*new_cases_7dayavg/population)
#View
```

Let's Plot It Round 4! 

```{r}
ggplot(finaldata %>% filter(country %in% countries), aes(x=date, y=rollingavg_per_million, color=country)) +  geom_line() + scale_x_date(date_breaks = "1 month", date_labels = "%b") + labs(x = "Date", y = "New Cases Per Million (7-day Rolling Average)", title = "New Cases Per Million Over Time") + guides(color = guide_legend(title="Country"))
```

What are some other cool ways you can visualize in R? 

*Heat Maps!* 

```{r}
# Pull out world map data frame
world_map = map_data("world")
country_key = data.frame(rbind(c("Antigua and Barbuda", "Antigua"), 
                               c("Burma", "Myanmar"), 
                               c("Cabo Verde", "Cape Verde"), 
                               c("Congo (Kinshasa)", 
                                 "Democratic Republic of the Congo"), 
                               c("Congo (Brazzaville)", 
                                 "Republic of Congo"), 
                               c("Cote d'Ivoire", "Ivory Coast"), 
                               c("Czechia", "Czech Republic"), 
                               c("Eswatini", "Swaziland"), 
                               c("Holy See", "Vatican"), 
                               c("Korea, South", "South Korea"), 
                               c("North Macedonia", "Macedonia"), 
                               c("Saint Kitts and Nevis", "Saint     Kitts"), 
                               c("Saint Vincent and the Grenadines", 
                                 "Saint Vincent"), 
                               c("Taiwan*", "Taiwan"), 
                               c("Trinidad and Tobago", "Trinidad"), 
                               c("United Kingdom", "UK"), 
                               c("US", "USA")))
names(country_key) = c("JHU", "map")

# Create named vector for recoding country names
recode_map = country_key$JHU; names(recode_map) = country_key$map

# Recode country names in world map data to match with Johns Hopkins
world_map = world_map %>% mutate(region=recode(region, !!!recode_map))

# Only three countries in finaldata don't match with anything in world_map
setdiff(finaldata$country, world_map$region)

# Filter finaldata for October 18, 2020 (3 weeks after the start of the war) and join with world map data
finaldata_map = finaldata %>% filter(date==date("2020-10-18")) %>% left_join(world_map, by=c("country"="region"))
```

*Heatmap of Cases Per Million on October 18, 2020*

```{r}
ggplot(finaldata_map, aes(x = long, y = lat, group = group)) + geom_polygon(aes(fill=rollingavg_per_million), color = "white") + 
  theme(panel.grid.major = element_blank(), 
            panel.background = element_blank(),
            axis.title = element_blank(), 
            axis.text = element_blank(),
            axis.ticks = element_blank()) + 
  scale_fill_viridis_c(name = "New cases/mill \n(7-day avg)", 
                       option = "inferno", 
                       trans = "log10") + 
  labs(title = "New confirmed cases per million on October 18, 2020") 
```

#### Regression & Classification 

```{r}
#GARY WORK HERE :) 
```

